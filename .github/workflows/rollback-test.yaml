name: Rollback TEST

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to rollback to (e.g., 0.14.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: swissfederalarchives/lindas-admin-ch

jobs:
  rollback:
    name: Rollback TEST
    runs-on: ubuntu-latest

    permissions:
      packages: write

    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate deployment tag
        id: tags
        run: |
          TIMESTAMP=$(date -u '+%Y-%m-%d_%H%M%S')
          echo "test_tag=test_${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Pull version image
        run: |
          echo "Rolling back TEST to version ${{ github.event.inputs.version }}"
          docker pull $REGISTRY/$IMAGE_NAME:${{ github.event.inputs.version }}

      - name: Tag and push as TEST
        run: |
          docker tag $REGISTRY/$IMAGE_NAME:${{ github.event.inputs.version }} $REGISTRY/$IMAGE_NAME:${{ steps.tags.outputs.test_tag }}
          docker push $REGISTRY/$IMAGE_NAME:${{ steps.tags.outputs.test_tag }}

      - name: Summary
        run: |
          echo "## Rollback TEST Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rolled back to | \`${{ github.event.inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Flux tag | \`${{ steps.tags.outputs.test_tag }}\` |" >> $GITHUB_STEP_SUMMARY
